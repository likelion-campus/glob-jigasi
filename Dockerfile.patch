# 1단계: 현재 프로젝트를 빌드해서 수정된 클래스 파일만 추출
FROM maven:3.8.6-openjdk-11-slim AS builder

WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline -B

COPY src ./src
RUN mvn clean compile -DskipTests

# 2단계: 기본 Jitsi 이미지에서 수정된 클래스만 교체
FROM jitsi/jigasi:stable-10184

# 수정된 VoskTranscriptionService.class 파일을 기존 JAR에 덮어쓰기
COPY --from=builder /app/target/classes/org/jitsi/jigasi/transcription/VoskTranscriptionService*.class /tmp/

# JAR 파일 업데이트
RUN cd /tmp && \
    jar -uf /usr/share/jigasi/jigasi.jar \
    org/jitsi/jigasi/transcription/VoskTranscriptionService*.class && \
    rm -f /tmp/VoskTranscriptionService*.class

# 나머지는 기본 이미지 설정 그대로 사용
